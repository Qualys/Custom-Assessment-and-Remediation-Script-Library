Import-Module webAdministration
$site = "iis:\sites\Default Web Site"
$filterRoot = "system.webServer/rewrite/rules/rule[@name='Zeroday']"
Add-WebConfigurationProperty -pspath $site -filter "system.webServer/rewrite/rules" -name "." -value @{name='Zeroday' + $_ ;patternSyntax='Regular Expressions';stopProcessing='True'}
Set-WebConfigurationProperty -pspath $site -filter "$filterRoot/match" -name "url" -value "*"
Set-WebConfigurationProperty -PSPath $site -filter "$filterRoot/conditions" -name '.' -value @{input='{REQUEST_URI}'; matchType='0'; pattern='.*autodiscover\.json.*\@.*Powershell.*'; ignoreCase='False'; negate='False'}
New-NetFirewallRule -DisplayName "HTTP/S Port Block" -Direction Inbound -LocalPort 5985,5986 -Protocol TCP -Action Block | out-null
Write-Output "URL Rewrite Instructions as per MSRC have been applied and exposed Remote PowerShell ports have been blocked. There is no known impact to Exchange functionality if the URL Rewrite module is installed as recommended."