#!/bin/bash

if command -v zmcontrol >/dev/null 2>&1
then    
    os_name=$(cat /etc/os-release 2> /dev/null | awk -F '=' '/^NAME/{print $2}'| tr -d '"')
    os_versionid=$(cat /etc/os-release 2> /dev/null | awk -F '=' '/^VERSION_ID/{print $2}' | awk '{print $1}' | tr -d '"')
    if command -v dnf || command -v yum >/dev/null 2>&1
    then
        case $os_versionid in
            7.*)
                echo "OS version $os_name"
                echo "OS version $os_versionid"
                yumcmd="yum install -y"
                if ! rpm --quiet --query pax >/dev/null 2>&1 ; then
                    yumcmd="$yumcmd pax"
                    eval $yumcmd >/dev/null 2>&1
                    su zimbra -
                    zmcontrol restart
                else
                    echo "pax already installed, no action needed"
                fi
            ;;
            8.*)
                echo "OS version $os_name"
                echo "OS version $os_versionid"
                dnfcmd="dnf install -y"
                if ! rpm --quiet --query spax >/dev/null 2>&1 ; then
                    dnfcmd="$dnfcmd spax"
                    eval $dnfcmd >/dev/null 2>&1       
                    su zimbra -
                    zmcontrol restart
                else
                    echo "spax already installed, no action needed"
                fi
            ;;
            *)
                echo "Version for CentOS or its derivatives is not 7 or 8, no acton needed."
            ;;
        esac
    elif [ "$os_name" == "Ubuntu" ]
    then
        echo "System is Ubuntu"
        echo "OS Name $os_name"
        echo "OS version $os_versionid"
        REQUIRED_PKG="pax"
        PKG_OK=$(dpkg-query -W --showformat='${Status}\n' $REQUIRED_PKG|grep "install ok installed")
        echo Checking for $REQUIRED_PKG: $PKG_OK
        if [ "" = "$PKG_OK" ]; then
            echo "No $REQUIRED_PKG. Setting up $REQUIRED_PKG."
            apt-get --yes install $REQUIRED_PKG >/dev/null 2>&1
            su zimbra -
            zmcontrol restart
        else
            echo "pax already installed, no action needed"
        fi

    else
        echo "System is $os_name"
        echo "Zimbra has provided workaround only for CentOS (CentOS derivatives) and Ubuntu. Refer https://blog.zimbra.com/2022/09/security-update-make-sure-to-install-pax-spax/"
    fi
else
    echo "zimbra not installed, no action is needed"
fi